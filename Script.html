/* ================= CONFIG ================= */
const OPEN_TIME  = new Date("2026-01-25T08:00:00+03:00");
const CLOSE_TIME = new Date("2026-01-25T17:00:00+03:00");
const POSITIONS = ["President","Secretary","Treasurer"];

/* ================= POST: VOTE ================= */
function doPost(e) {
  const data = JSON.parse(e.postData.contents || "{}");
  const { student_id, position, candidate } = data;

  if (!student_id || !position || !candidate)
    return respond("Invalid request","error");

  const now = new Date();
  if (now < OPEN_TIME || now > CLOSE_TIME)
    return respond("â›” Voting Closed","error");

  const ss = SpreadsheetApp.getActive();

  /* Validate student */
  const students = ss.getSheetByName("Students")
    .getRange("A2:A").getValues().flat().filter(String);

  if (!students.includes(student_id))
    return respond("Student ID not registered","error");

  /* Prevent multiple votes per position */
  const votesSheet = ss.getSheetByName("Votes");
  const votes = votesSheet.getDataRange().getValues();

  for (let i = 1; i < votes.length; i++) {
    if (votes[i][1] === student_id && votes[i][2] === position)
      return respond(`Already voted for ${position}`,"error");
  }

  votesSheet.appendRow([
    new Date(),
    student_id,
    position,
    candidate
  ]);

  return respond(`Vote for ${candidate} recorded successfully`,"success");
}

/* ================= GET: RESULTS ================= */
function doGet() {
  const ss = SpreadsheetApp.getActive();
  const cand = ss.getSheetByName("Candidates").getDataRange().getValues();
  const votes = ss.getSheetByName("Votes").getDataRange().getValues();

  const results = {};
  POSITIONS.forEach(p => results[p] = []);

  /* Init candidates */
  for (let i = 1; i < cand.length; i++) {
    results[cand[i][1]].push({
      candidate: cand[i][0],
      votes: 0
    });
  }

  /* Count votes */
  for (let i = 1; i < votes.length; i++) {
    const pos = votes[i][2];
    const name = votes[i][3];
    const c = results[pos].find(x => x.candidate === name);
    if (c) c.votes++;
  }

  return ContentService.createTextOutput(JSON.stringify({
    votingOpen: new Date() >= OPEN_TIME && new Date() <= CLOSE_TIME,
    show:{
      President:true,
      Secretary:true,
      Treasurer:true
    },
    results
  })).setMimeType(ContentService.MimeType.JSON);
}

/* ================= HELPER ================= */
function respond(message,status){
  return ContentService.createTextOutput(
    JSON.stringify({message,status})
  ).setMimeType(ContentService.MimeType.JSON);
}

  https://script.google.com/macros/s/AKfycbwFqV9NufMMFdQBHGVQsMJdDFQpiZ-7hinoqpwht9hfuh3SH2qLucStXM01N6fZUsOEwQ/exec   


  https://script.google.com/macros/s/AKfycbxrDT1RB4c33xNT8SuNH1twvnuWlz_nKhXajVuBCW_EATRZwqZ_eKvtXh7Dp96Pt88SaQ/exec

  https://script.google.com/macros/s/AKfycbw9AlN7bZbWOkSI-Vgj0p_qp5_4fBVB32R41Mf-C94EVgzIyhQ12Kobq2KgvclObiMVQA/exec

  https://script.google.com/macros/s/AKfycbzSX5eePC_LBK-xTwkz60FUd1qR8dO5b2b_nKdh4LscF5C5PHXRu6Qe5C07m38mCTcnMw/exec

  https://script.google.com/macros/s/AKfycbyvUo0mDze9Sczrxf9ja-qP6oZxYPDsJjJ_xRTaBzNu1AaLb-WCptTbjj7l7qrVoJeSNw/exec

https://script.google.com/macros/s/AKfycbzN81jQkJaD6RC3f2AhmmoQstDUG0JMRWtdGSQ5aLbUwLiES-bKj2iK-k5NmjWttUgr/exec
